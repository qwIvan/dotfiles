#!/bin/bash

#自动翻墙脚本，配合shadowsocks-libev的ss-redir使用。需要ipset

chnroute_file=~/.chnroute
sudo ipset create chnroute hash:net -exist
sudo cat $chnroute_file | sudo xargs -I ip ipset add chnroute ip -exist
sudo ip route add local default dev lo table 100
sudo ip rule add fwmark 1 lookup 100
sudo cat ~/.iptables-rules | sudo iptables-restore
#sudo sysctl net/ipv6/conf/all/disable_ipv6=1
curl 'http://ftp.apnic.net/apnic/stats/apnic/delegated-apnic-latest' | grep ipv4 | grep CN | awk -F\| '{ printf("%s/%d\n", $4, 32-log($5)/log(2)) }' > $chnroute_file.bak
if [[ $? -ne 0 ]]; then
  exit 12345
fi
if [[ ! -s $chnroute_file.bak ]]; then
  exit 12346
fi
#echo "127.0.0.1/24" >> $chnroute_file.bak
cp -f $chnroute_file.bak $chnroute_file
